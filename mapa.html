<!DOCTYPE html>
<html lang="es">  
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Interactivo Gamificado</title>
  <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <div id="particles-js"></div>

  <nav class="menu">
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="mapa.html">Mapa</a></li>
    <li><a href="about.html">About Us</a></li>
  </ul>
</nav>

  <div id="scene">
    <div class="hub hub1" data-title="Phishing"></div>
    <div class="hub hub2" data-title="Smishing"></div>
    <div class="hub hub3" data-title="Vishing"></div>
    <div class="hub hub4" data-title="Clonaci√≥n de p√°ginas web"></div>
    <div class="hub hub5" data-title="Datos Impactantes"></div>
    <div class="hub hub6" data-title="Datos Curiosos"></div>
    

  </div>

  <div class="info-card card-base">
    <h2>Explora el Mapa</h2>
    <p id="default-info">
      Aqu√≠ puedes interactuar con la red de nodos.<br><br>
      ‚ö™ Haz clic en cada nodo blanco para descubrir informaci√≥n.<br>
      üñ±Ô∏è Usa la rueda del mouse para desplazarte y explorar m√°s nodos.<br>
      üñ±Ô∏è Cuando est√©s dentro de un panel, toca el fondo para salir y continuar explorando. <br>
      üì°  Nuestro dise√±o muestra c√≥mo todo est√° interconectado: cada nodo representa conexiones dentro de la red, reflejando c√≥mo nosotros y el internet formamos una red viva y en constante movimiento.
    </p>
  </div>

  <div class="overlay card-base" id="overlay"></div>
  
  <script>

    // Aplica la animaci√≥n al cargar
    

    // Antes de salir, hace el fade-out
    document.querySelectorAll("a").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault(); // detiene el cambio inmediato
        let href = link.getAttribute("href");
        document.body.style.opacity = 0;
        setTimeout(() => {
          window.location.href = href;
        }, 800); // mismo tiempo que el transition
      });
    });


    /* Fondo part√≠culas */
    particlesJS("particles-js", {
      particles: {
        number: { value: 400 },
        color: { value: "#ffffff" },
        shape: { type: "circle" },
        opacity: { value: 0.6 },
        size: { value: 3, random: true },
        line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.5, width: 1 },
        move: { enable: true, speed: 4 }
      },
      interactivity: { events: { onhover: { enable: false } } },
      retina_detect: true
    });

    document.addEventListener('DOMContentLoaded', () => {


    
      document.body.classList.add("fade-in");
    

      const hubs = document.querySelectorAll('.hub');
      const scene = document.getElementById('scene');
      const overlay = document.getElementById('overlay');
      const infoCard = document.querySelector('.info-card');
      const menu = document.querySelector('.menu');


      /* ====== Contenido de paneles por hub ====== */
      const info = {

        hub1: [

        /*  Panel 1  */
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">
            <h1>Phishing</h1>
            <h2>¬øQu√© es?</h2>
            <p>
              El phishing es un m√©todo de fraude digital en el que delincuentes env√≠an correos 
              electr√≥nicos falsos que parecen ser de bancos, la DIAN u otras entidades confiables.
            </p>
            <p>
              El objetivo es enga√±ar al usuario para que entregue datos sensibles como contrase√±as,
              n√∫meros de tarjetas o informaci√≥n personal.
            </p>


            <h2>¬øC√≥mo NO caer en Enredos?</h2>
            <div class="panel-right">
            <ul>
              <li>Verifica siempre el remitente del correo antes de abrir enlaces.</li>
              <li>No ingreses a enlaces sospechosos, escribe directamente la direcci√≥n oficial en el navegador.</li>
              <li>Nunca compartas contrase√±as, n√∫meros de tarjeta o datos personales por correo.</li>
              
            </ul>
          </div>



          </div>
        </div>`,


         /*  Panel 2  */
                
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">
            <h2>¬øQu√© hacer en caso de ser v√≠ctima?</h2>
            <ul>
              <li>Reporta al correo de la DIAN, <a href="mailto:phishing-report@colcert.gov.co">phishing-report@colcert.gov.co</a></li>
              <li>Denuncia en el CAI Virtual, <a href="https://caivirtual.policia.gov.co" target="_blank">caivirtual.policia.gov.co</a></li>
              <li>Si hay amenazas, llamar al GAULA 165.</li>
              <li>Reenv√≠a al n√∫mero 7726 (SPAM) para que lo bloquee tu operador.</li>
            </ul>
          </div>
        </div>`,


        

        ],
        hub2: [
          /*  Panel 1  */
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">
            <h1>Smishing</h1>
            <h2>¬øQu√© es?</h2>
            <p>
             El smishing es una variante del phishing que se realiza a trav√©s de mensajes de texto (SMS).
            Los delincuentes env√≠an mensajes falsos que suelen pedir informaci√≥n privada o invitan a entrar 
            a enlaces maliciosos.
            </p>
            <p>
              El objetivo es enga√±ar al usuario para que entregue datos sensibles como contrase√±as,
              n√∫meros de tarjetas o informaci√≥n personal.
            </p>

            <h2>Riesgos principales</h2>
            <ul>
              <li>Robo de informaci√≥n personal</li>
              <li>Fraude financiero.</li>
              <li>Extorsi√≥n o chantaje  </li>
            </ul>
          </div>
        </div>`,


         /*  Panel 2  */
                
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
         
          <div class="panel-right">
           <h2>¬øComo NO caer en Enredos?</h2>
          <ul>
            <li>No responder mensajes de texto de remitentes desconocidos o sospechosos.</li>
            <li>No ingresar contrase√±as bancarias en sitios enviados por SMS o WhatsApp.</li>
            <li>Nunca entregar n√∫mero de identificaci√≥n, tarjetas d√©bito/cr√©dito, c√≥digos de seguridad ni contrase√±as.</li>
            <li>Si recibes un mensaje indicando que tu banco bloque√≥ productos y pide ingresar a un enlace, ign√≥ralo.</li>
            <li>Comun√≠cate directamente con la l√≠nea oficial de atenci√≥n al cliente de tu banco.</li>
          </ul>
        </div>


        </div>`,


          

        ],
        hub3: [
          /*  Panel 1  */
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">
            <h1>Vishing</h1>
            <h2>¬øQu√© es?</h2>
            <p>
            El Vishing es una t√©cnica de fraude en la que los delincuentes utilizan llamadas telef√≥nicas para enga√±ar a las personas y obtener informaci√≥n sensible, como datos bancarios o personales.
            Un m√©todo com√∫n son las llamadas silenciosas, donde nadie responde al contestar; esto se hace para verificar si la l√≠nea est√° activa y pertenece a alguien. Incluso un simple ‚Äús√≠‚Äù puede ser grabado y usado como prueba de consentimiento.
            </p>
            
            <h2>Riesgos principales</h2>
            <ul>
              <li>Robo de identidad e informaci√≥n personal.</li>
              <li>Intentos de persuadir para hacer compras falsas o entregar datos sensibles.</li>
              <li>Enlaces maliciosos enviados por llamada o mensaje.</li>
            </ul>
          </div>
        </div>`,


         /*  Panel 2  */
                
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" controls>
              <source src="videos/qrVideo.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">
        
            <h2>¬øComo NO caer en Enredos?</h2>
            <ul>
              <li>No conf√≠es en llamadas que dicen ser de bancos o entidades: recuerda que <strong>ninguna entidad pedir√° tus datos por tel√©fono</strong>.</li>
              <li>Nunca hagas clic en enlaces recibidos durante una llamada.</li>
              <li>Verifica siempre la informaci√≥n en los <strong>canales oficiales</strong> de la empresa.</li>
              <li>Instala un identificador de llamadas para mayor seguridad.</li>
              <li>No devuelvas llamadas a n√∫meros sospechosos o internacionales.</li>
              <li>Bloquea los n√∫meros reiterativos que insistan en contactarte.</li>
            </ul>

      
          </div>
        </div>`,



        ],



        hub4: [
          /*  Panel 1  */
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">
            <h1>Clonaci√≥n de p√°ginas web</h1>
            <h2>¬øQu√© es?</h2>
            <p>
            La clonaci√≥n de p√°ginas web ocurre cuando un delincuente crea un sitio falso que imita a uno leg√≠timo (usando logotipos, colores y tipograf√≠as similares).
            El objetivo es robar datos personales, credenciales de acceso o informaci√≥n de pago.
            Suele usarse junto con campa√±as de phishing.
            </p>

            
            <h2>¬øComo NO caer en Enredos?</h2>  
            <ul>
              <li>Revisa siempre que el link o URL coincida exactamente con la p√°gina oficial.</li>
              <li>Evita ingresar desde enlaces de anuncios o mensajes de origen desconocido.</li>
              <li>En compras online, verifica que el comercio sea reconocido y que la informaci√≥n coincida con el lugar.</li>
              <li>No entregues informaci√≥n de pago en p√°ginas redireccionadas o con descuentos poco cre√≠bles.</li>
              
            </ul>
          
            
          </div>
        </div>`,




        /*  Panel 2  */
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" controls>
              <source src="videos/video1.mp4" type="video/mp4">>
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">

            <h2>T√°cticas m√°s comunes</h2>
            <ul>
              <li><strong>Typosquatting:</strong> Cambian una letra o usan caracteres similares para que la URL se vea leg√≠tima (ejemplo: <em>banccolombia.com</em> en vez de <em>bancolombia.com</em>).</li>
              <li><strong>Suplantaci√≥n de dominio:</strong> Usan subdominios o incluso certificados v√°lidos (candado verde) para parecer confiables.</li>
              <li><strong>Clone phishing:</strong> Env√≠an correos o mensajes casi id√©nticos a los reales, pero con enlaces alterados que llevan al sitio clonado.</li>
              <li><strong>Skimming digital (e-commerce):</strong> Insertan c√≥digo malicioso en p√°ginas de pago para robar datos de tarjetas, incluso en sitios leg√≠timos que fueron hackeados.</li>
            </ul>
            
            
          </div>
        </div>`,




        /*  Panel 3  */
        `<div class="panel-layout">
          <div class="panel-left">
            <video width="100%" >
              <source src="videos/video1.mp4" type="video/mp4">
              Tu navegador no soporta el video.
            </video>
          </div>
          <div class="panel-right">

            <h2>¬øFuiste Victima?</h2>
            <ul>
              <li>Si fuiste v√≠ctima, bloquea tus tarjetas, cambia contrase√±as y guarda evidencias (URLs, recibos, capturas).</li>
              <li>Denuncia la suplantaci√≥n de sitios web ante la Polic√≠a como delito inform√°tico.</li>
              <li>Reporta el fraude a tu banco de inmediato si hubo uso de tarjetas o datos financieros.</li>
            </ul>
            
            
          </div>
        </div>`,


            


        ],

        hub5: [
          /*  Panel 1  */
        `<div class="panel-layout">
         


          <div class="panel-right">
            <h1>Datos Impactantes</h1>
           
            <ul>


              <li>
                <h1>M√°s del 90%</h1>
                <p>De los encuestados a recibido al menos un intento de estafa digital</p>
              </li>


              <li>
                <h1>M√°s del 35%</h1>
                <p>De los encuestados han sido victimas estafas digitales</p>
              </li>


              <li>
                <h1>Fraudes M√°s comunes</h1>
                <p>Mensajes de Texto,llamadas falsas y mensaje v√≠a WhatsApp</p>
              </li>

              <li>
                <h1>M√°s del 90%</h1>
                <p>Piensa que no hay suficiente informaci√≥n ni educacion del</p>
              </li>

              
            </ul>
          
            
          </div>
        </div>`,

          ],



          hub6: [
          /*  Panel 1  */
        `<div class="panel-layout">
          
         

          <div class="panel-right">
            <h1>Datos Curiosos</h1>
            
            <ul>

              <li>
                <h1>7726  </h1>
                <p>¬øTe llega un mensaje fraudulento? Reenv√≠alo al 7726. As√≠ ayudas a tu operador a detectarlo y bloquearlo.</p>
              </li>

              <li>
                <h1>Registro de N√∫meros Excluidos (RNE)</h1>
                <p>nscribe gratis tu n√∫mero en el RNE para dejar de recibir llamadas, mensajes de texto, correos o chats publicitarios no deseados.</p>
              </li>

              <li>
                <h1>Ley de Habeas Data</h1>
                <p>Cualquier persona puede pedir a una empresa que corrija, actualice o elimine sus datos personales de sus bases.</p>
              </li>


              <li>
                <h1>Bloqueo gratuito</h1>
                <p>Si te roban el tel√©fono, puedes reportar el IMEI a tu operador y quedar√° bloqueado en todas las redes del pa√≠s</p>
              </li>

            </ul>
            
          </div>
        </div>`,

          ],
      };

      /* ====== √Årboles de decisiones (puedes editar textos y ramificaciones) ====== */
      const TREES = {
        hub1: { // QR malos
          question: "Recibes un correo de la DIAN diciendo que tienes sanciones y debes entrar a un enlace. ¬øQu√© haces?",
            options: [
              {
                text: "Hago clic en el enlace y pongo mis datos para 'evitar problemas'.",
                result: { ok: false, why: "¬°Cuidado! Era phishing y entregaste tu informaci√≥n personal." }
              },
              {
                text: "Reviso el remitente del correo y noto que no coincide con la DIAN.",
                next: {
                  question: "El correo se ve raro. ¬øQu√© decides hacer?",
                  options: [
                    {
                      text: "Conf√≠o, porque el correo se parece al real.",
                      result: { ok: false, why: "Era un correo falso con URL alterada. Te hicieron caer en phishing." }
                    },
                    {
                      text: "No ingreso al enlace y reporto el caso al CAI Virtual.",
                      result: { ok: true, why: "¬°Bien hecho! Evitaste el fraude y ayudaste a detenerlo." }
                    }
                  ]
                }
              }
            ]
        },
        hub2: { // Links err√≥neos
          question: "Recibes un SMS de tu 'banco' diciendo que tu cuenta fue bloqueada y debes entrar a un link. ¬øQu√© haces?",
            options: [
              {
                text: "Hago clic en el link y escribo mis datos bancarios.",
                result: { ok: false, why: "¬°Cuidado! Era smishing y ahora tienen acceso a tu cuenta." }
              },
              {
                text: "Ignoro el mensaje porque sospecho que es fraude.",
                next: {
                  question: "¬øQu√© decides hacer despu√©s de ignorar el mensaje?",
                  options: [
                    {
                      text: "No hago nada, lo dejo pasar.",
                      result: { ok: false, why: "El n√∫mero seguir√° activo. Mejor reportarlo para evitar m√°s v√≠ctimas." }
                    },
                    {
                      text: "Reenv√≠o el mensaje al 7726 (SPAM) y llamo al banco oficial.",
                      result: { ok: true, why: "¬°Excelente! Reportaste el fraude y protegiste tu dinero." }
                    }
                  ]
                }
              }
            ]
        },



        hub3: { // llamadas
          question: "Recibes una llamada de una 'empresa de mensajer√≠a' diciendo que tu paquete est√° retenido en aduana y debes dar datos personales. ¬øQu√© haces?",
            options: [
              {
                text: "Doy mi n√∫mero de c√©dula y tarjeta para 'liberar el paquete'.",
                result: { ok: false, why: "¬°Cuidado! Era vishing y usaron tus datos para fraude." }
              },
              {
                text: "Cuelgo porque sospecho de la llamada.",
                next: {
                  question: "Despu√©s de colgar, ¬øqu√© decides hacer?",
                  options: [
                    {
                      text: "Ignoro la llamada y sigo con mi d√≠a.",
                      result: { ok: false, why: "El fraude sigue activo, debiste reportar el n√∫mero sospechoso." }
                    },
                    {
                      text: "Llamo a la empresa de mensajer√≠a por sus canales oficiales.",
                      result: { ok: true, why: "¬°Muy bien! Confirmaste con la empresa real y evitaste la estafa." }
                    }
                  ]
                }
              }
            ]
        },



        hub4: { // paginas web  
          question: "Ves una p√°gina casi id√©ntica a una tienda online famosa con descuentos del 80%. ¬øQu√© haces?",
            options: [
              {
                text: "Aprovecho la oferta y pongo mis datos de tarjeta.",
                result: { ok: false, why: "¬°Cuidado! Era una p√°gina clonada y robaron tus datos financieros." }
              },
              {
                text: "Reviso la URL y noto que no coincide exactamente con la tienda oficial.",
                next: {
                  question: "El sitio parece sospechoso. ¬øQu√© decides hacer?",
                  options: [
                    {
                      text: "Conf√≠o, porque el logo y dise√±o se ven iguales.",
                      result: { ok: false, why: "Era un clon perfecto. Usaron typosquatting para enga√±arte." }
                    },
                    {
                      text: "No compro y reporto el sitio como fraude.",
                      result: { ok: true, why: "¬°Excelente! Detectaste la p√°gina clonada y evitaste el fraude." }
                    }
                  ]
                }
              }
            ]
        },

        hub5: { // M√°s cosas
          question: "LOCA",
          options: [
            { text: "Lo conecto para revisar", result: { ok: false, why: "Riesgo de BadUSB. Podr√≠a ejecutar c√≥digo malicioso." } },
            {
              text: "Lo entrego a TI",
              next: {
                question: "TI indica que puede estar comprometido. ¬øQu√© haces?",
                options: [
                  { text: "Lo uso igual", result: { ok: false, why: "Ignorar pol√≠ticas de TI aumenta el riesgo." } },
                  { text: "Lo descarto seg√∫n protocolo", result: { ok: true, why: "Acci√≥n correcta seg√∫n procedimiento." } }
                ]
              }
            }
          ]
        }
      };

      let activeHub = null, activeKey = null, currentIndex = 0;

      overlay.addEventListener('click', (e) => e.stopPropagation());

      hubs.forEach(hub => {
  hub.addEventListener('click', e => {
    e.stopPropagation();

    if (activeHub === hub) { 
      resetView(); 
      return; 
    }

    // Ocultar TODOS los hubs
    hubs.forEach(h => {
      h.classList.add('hidden');
      h.classList.remove('active');
    });

    // Ocultar el panel fijo de la derecha
    infoCard.classList.add("hidden");

    activeHub = hub;
    activeKey = [...hub.classList].find(c => /^hub\d+$/.test(c));
    currentIndex = 0;

    // Ocultar men√∫ con fade
    menu.classList.add('hidden');

    // Zoom al nodo clicado
    const rect = hub.getBoundingClientRect();
    const nodeCenterX = rect.left + rect.width / 2;
    const nodeCenterY = rect.top + rect.height / 2;
    const offsetX = window.innerWidth / 2 - nodeCenterX;
    const offsetY = window.innerHeight / 2 - nodeCenterY;
    scene.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(2)`;

    // Renderiza panel espec√≠fico del nodo
    renderPanel();

    overlay.classList.add('active');
    document.body.classList.add("modal-open");

    infoCard.style.opacity = 0;
  });
});




     function renderPanel() {
  let controlsHTML = "";

  const lastIndex = info[activeKey].length - 1;

  if (currentIndex > 0) {
    controlsHTML += `<button id="prevBtn">Anterior</button>`;
  }

  if (currentIndex < lastIndex ) {
    controlsHTML += `<button id="nextBtn">Siguiente</button>`;
  }

  if (currentIndex === lastIndex && activeKey !== "hub5" && activeKey !== "hub6") {
    controlsHTML += `<button id="startGameBtn">Poner a prueba</button>`;
  }

  

  const totalBtns = (controlsHTML.match(/<\/button>/g) || []).length;
  const controlsClass = totalBtns === 1 ? "controls single" : "controls";

  overlay.innerHTML = `
  <div class="panel ${activeKey === "hub6" ? "hub6-style" : ""}">
    ${info[activeKey][currentIndex]}
    <div class="${controlsClass}">
      ${controlsHTML}
    </div>
  </div>
`;


  const panel = overlay.querySelector('.panel');
  requestAnimationFrame(() => panel.classList.add('in'));

  // Eventos de botones
  const prevBtn = overlay.querySelector('#prevBtn');
  const nextBtn = overlay.querySelector('#nextBtn');
  const gameBtn = overlay.querySelector('#startGameBtn');

  if (prevBtn) {
    prevBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (currentIndex > 0) {
        currentIndex--;
        renderPanel();
      }
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (currentIndex < lastIndex) {
        currentIndex++;
        renderPanel();
      }
    });
  }

  if (gameBtn) {
    gameBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      startDecisionGame(activeKey);
    });
  }

  overlay.querySelectorAll('button,a').forEach(el => 
    el.addEventListener('click', ev => ev.stopPropagation())
  );

  /* üëâ aqu√≠ la magia: reproducir video autom√°ticamente si existe */
  const video = overlay.querySelector(".panel-left video");
  if (video) {
    video.currentTime = 0;
    video.play().catch(err => console.log("Autoplay bloqueado:", err));
  }
}


    /* ====== Auto-reproducir video al abrir panel ====== */
function playPanelVideo() {
  const video = document.querySelector(".overlay.active .panel-left video");
  if (video) {
    video.currentTime = 0; // empieza desde 0
    video.play().catch(err => console.log("Autoplay bloqueado:", err));
  }
}

document.addEventListener("transitionend", (e) => {
  if (e.target.classList.contains("overlay") && e.target.classList.contains("active")) {
    playPanelVideo();
  }
});

      /* ====== Juego tipo √°rbol ====== */
      function startDecisionGame(topicKey) {
        const tree = TREES[topicKey] || TREES.hub1;

        overlay.innerHTML = `
    <div class="panel in">
      <h2>Decisi√≥n interactiva</h2>
      <div class="game-wrap card-base">
        <div class="game-canvas">
          <svg class="tree-svg" xmlns="http://www.w3.org/2000/svg"></svg>
          <div class="nodes-layer"></div>
        </div>
      </div>
    </div>
  `;

        const gameWrap = overlay.querySelector('.game-wrap');
        const canvas   = overlay.querySelector('.game-canvas');
        const svg      = overlay.querySelector('.tree-svg');
        const nodesLay = overlay.querySelector('.nodes-layer');

        let depth = 0;                 // nivel actual (fila)
        const rowGap = 200;            // distancia vertical entre filas
        const baseY = 120;              // margen superior
        const nodesByDepth = [];       // guardamos nodos DOM por nivel para limpiar ramas
        const centers = [50, 30, 70, 30, 70]; // posiciones X en % por fila

        // Ajustar altura din√°mica del lienzo
        function ensureHeightFor(d) {
          const needed = baseY + (d+2) * rowGap;
          svg.style.height = needed + "px";
          nodesLay.style.height = needed + "px";
        }
        function pctXToPx(percent) {
          const w = nodesLay.clientWidth;
          return (w * percent) / 100;
        }
        function yForRow(r) { return baseY + r*rowGap; }

        // Dibuja l√≠nea con animaci√≥n simple
       function drawLink() { /* No hacemos nada, as√≠ no aparecen l√≠neas */ }


        // Crea un nodo visual
        function makeNode({ text, xPct, row, klass = "", clickable = false, onClick }) {
          ensureHeightFor(row);
          const node = document.createElement("div");
          node.className = `glass-node ${klass}`;
          node.textContent = text;
          const xpx = pctXToPx(xPct) - 80; // centrado (160px/2)
          const ypx = yForRow(row) - 80;
          node.style.left = `${xpx}px`;
          node.style.top  = `${ypx}px`;
          if (clickable) {
            node.addEventListener("click", (e) => {
              e.stopPropagation();
              onClick && onClick();
            });
          } else {
            node.classList.add("disabled");
          }
          nodesLay.appendChild(node);
          (nodesByDepth[row] ||= []).push(node);
          return { 
  node, 
  cx: xpx + node.offsetWidth / 2, 
  cy: ypx + node.offsetHeight / 2,
  rx: node.offsetWidth / 2,
  ry: node.offsetHeight / 2
};

        }

        // Limpia niveles > row (cuando se cambia de rama)
        function clearBelow(row) {
  for (let r = row + 1; r < nodesByDepth.length; r++) {
    (nodesByDepth[r] || []).forEach(n => {
      // Agrega clase de fade-out
      n.classList.add('fade-out');
      // Guarda todas las l√≠neas que conectan a este nodo
      const lines = [...svg.querySelectorAll("line")].filter(L => {
        const y1 = +L.getAttribute("y1");
        return y1 >= n.offsetTop;
      });
      // Fuerza reflujo
      void n.offsetWidth;
      // Espera animaci√≥n antes de eliminar
      setTimeout(() => {
        if (n.parentNode) n.parentNode.removeChild(n);
        lines.forEach(L => L.remove());
      }, 300);
    });
    nodesByDepth[r] = [];
  }
}




        // Peque√±o "pan/zoom" hacia el nivel
        function focusRow(row) {
          const shift = Math.max(0, (row-1) * 80);
          canvas.style.transform = `translateY(-${shift}px) scale(1.02)`;
          setTimeout(() => { canvas.style.transform = `translateY(-${shift}px) scale(1)`; }, 320);
        }

        // Render recursivo
        function renderNode(nodeData, row, parentPos) {
          focusRow(row);
          // Root o siguiente pregunta
          const xPct = (row === 0) ? 50 : 50; // pregunta centrada siempre
          const q = makeNode({ text: nodeData.question, xPct, row, klass: "question", clickable: false });
          if (parentPos) { drawLink(parentPos.cx, parentPos.cy, q.cx, q.cy); }

          // Mostrar opciones con delay para efecto de ‚Äúaparecer‚Äù
          setTimeout(() => {
            const opts = nodeData.options || [];
            const leftX  = 30, rightX = 70;
            // Dos opciones: izquierda/derecha
            const left = makeNode({
              text: opts[0].text, xPct: leftX, row: row+1, klass: "option", clickable: true,
              onClick: () => handleChoice(opts[0], row+1, q)
            });
            const right = makeNode({
              text: opts[1].text, xPct: rightX, row: row+1, klass: "option", clickable: true,
              onClick: () => handleChoice(opts[1], row+1, q)
            });
            drawLink(q.cx, q.cy, left.cx, left.cy);
            drawLink(q.cx, q.cy, right.cx, right.cy);
          }, 250);
        }

       function showResult(res) {
  overlay.innerHTML = `
    <div class="panel in ${res.ok ? "success" : "error"}">
      <h2>${res.ok ? " ¬°Felicitaciones!" : "Respuesta incorrecta"}</h2>
      <p>${res.why}</p>
      <div class="controls">
        <button id="exitGame">Salir</button>
        <button id="restartGame">Reintentar</button>
      </div>
    </div>
  `;

  // Bot√≥n de reintentar ‚Üí reinicia el √°rbol
  overlay.querySelector("#restartGame").addEventListener("click", (e) => {
    e.stopPropagation();
    startDecisionGame(activeKey);
    menu.classList.remove("hidden");
    document.body.classList.remove("modal-open");
  });
}


        function handleChoice(choice, row, parentQ) {
          // Cambiar de rama: borra niveles inferiores y l√≠neas
          clearBelow(row-1);
          focusRow(row);
          // Si hoja -> resultado
          if (choice.result) {
            showResult(choice.result, row);
            return;
          }
          // Si hay siguiente pregunta -> render
          if (choice.next) {
            renderNode(choice.next, row, { cx: pctXToPx(50), cy: yForRow(row)-80 }); // desde centro de la fila previa
          }
        }

        // Inicio: render ra√≠z
        renderNode(tree, 0, null);

        // Controles
        overlay.querySelector("#exitGame").addEventListener("click", (e) => { e.stopPropagation(); resetView(); });
        overlay.querySelector("#restartGame").addEventListener("click", (e) => {
          e.stopPropagation();
          startDecisionGame(topicKey);
        });
      }

      /* ====== Cerrar overlay si clic afuera ====== */
      document.addEventListener('click', (e) => {
        const clickedInsideOverlay = e.target.closest('.overlay');
        const clickedHub = e.target.closest('.hub');
        if (activeHub && !clickedInsideOverlay && !clickedHub) resetView();
      });

       function resetView() {
  // Mostrar otra vez todos los hubs
  hubs.forEach(h => {
    h.classList.remove('hidden');
  });

  // Mostrar el panel fijo de la derecha
  infoCard.classList.remove("hidden");
  infoCard.style.opacity = 1; // por si lo dejaste en 0

  // Mostrar el men√∫ de nuevo
  menu.classList.remove("hidden");

  // Reset del zoom
  scene.style.transform = "translate(0,0) scale(1)";

  overlay.classList.remove('active');
  document.body.classList.remove("modal-open");
  activeHub = null;

  // Pausar video si hay uno abierto
const video = overlay.querySelector("video");
if (video) {
  video.pause();
  video.currentTime = 0;
}

}






    });
  </script>
</body>
</html>
